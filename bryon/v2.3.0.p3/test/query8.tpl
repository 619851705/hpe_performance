
select  s_store_name
      ,sum(ss_net_profit)
 from store_sales
     ,date_dim
     ,store,
     (select ca_zip
     from (
      SELECT substr(ca_zip,1,5) ca_zip
      FROM customer_address
      WHERE substr(ca_zip,1,5) IN (
                          '38020','37490','69218','88126','89710','50614',
                          '19813','21523','34089','27645','83879',
                          '26355','46500','53260','80466','60657',
                          '74807','44676','15415','29319','12840',
                          '78169','19375','39640','73166','99184',
                          '92080','21231','12074','88211','57824',
                          '54067','41580','12113','94770','66597',
                          '52950','11376','51887','87915','49173',
                          '29795','56607','40076','46250','61316',
                          '63040','12773','21098','84495','87455',
                          '73892','56920','25932','39933','98174',
                          '77647','45736','31918','58419','58313',
                          '14251','28904','12635','72695','36402',
                          '53718','69132','29983','98030','27451',
                          '92153','85032','50362','26857','23639',
                          '63700','23476','25329','31951','41073',
                          '35637','53776','22105','53456','27722',
                          '34270','61498','16970','30853','76027',
                          '52891','28480','42204','59227','14014',
                          '92074','57353','88979','14874','96810',
                          '67681','73879','70802','34917','57922',
                          '35941','58760','77491','45547','34436',
                          '13223','53916','72918','65108','29784',
                          '84902','51211','54483','53790','36097',
                          '77232','39401','23882','45149','51511',
                          '18497','57755','74899','13144','53923',
                          '29446','10525','27205','48115','41211',
                          '11706','50143','75956','53302','23828',
                          '73644','33581','44643','46877','34468',
                          '22943','73669','23670','55545','76040',
                          '19689','15737','62608','62344','16187',
                          '30269','40194','68312','50841','24773',
                          '14945','82804','64061','96507','21171',
                          '15941','43343','43654','99487','95190',
                          '20101','53478','13802','45697','55997',
                          '23826','41639','16146','38923','74736',
                          '96983','99939','20483','67646','25295',
                          '80489','50271','10865','68359','84250',
                          '40991','54681','40887','75173','75639',
                          '87736','81340','61492','82601','36405',
                          '19361','54086','16827','59206','31451',
                          '81732','47200','70431','40174','10117',
                          '78693','97901','63465','21111','76287',
                          '25777','32411','78112','68709','12316',
                          '15298','59215','93104','97764','81109',
                          '10921','64324','94112','18224','63559',
                          '61418','31397','27838','39931','45166',
                          '60411','51033','28794','93120','22965',
                          '18680','13663','10327','65009','43614',
                          '44072','66096','15140','54221','74289',
                          '14030','29982','97117','58308','55374',
                          '52305','95105','40161','48700','46611',
                          '57034','88078','42189','62507','40507',
                          '68814','63933','24525','15915','25236',
                          '29683','61415','30779','56921','49069',
                          '53982','39938','41827','99325','78308',
                          '16036','11198','92295','12697','19044',
                          '27506','64268','79514','76294','21847',
                          '38196','47895','35094','57942','20780',
                          '70714','79670','98858','29488','99863',
                          '77326','22299','43942','29859','57639',
                          '92452','85444','40484','66696','37564',
                          '10026','49251','46724','18575','11311',
                          '40908','99910','42745','44793','58670',
                          '66804','91901','42901','24823','29906',
                          '13748','86923','27104','91980','82558',
                          '54599','35468','79933','10242','15253',
                          '16932','11857','31800','63408','23652',
                          '57799','48948','65533','18117','85597',
                          '92239','14287','13355','97939','93169',
                          '40699','24415','77758','44945','67818',
                          '41589','14503','65963','51857','80232',
                          '25521','83232','81608','22596','78671',
                          '99879','45368','96324','63953','28429',
                          '86186','50783','14635','97449','30611',
                          '43853','13094','90017','17566','44928',
                          '98658','91232','56974','47065','14739',
                          '49298','20566','45522','64833','28835',
                          '16380','25543','15064','73475','37404',
                          '94625','60963','38748','33093')
     intersect
      select ca_zip
      from (SELECT substr(ca_zip,1,5) ca_zip,count(*) cnt
            FROM customer_address, customer
            WHERE ca_address_sk = c_current_addr_sk and
                  c_preferred_cust_flag='Y'
            group by ca_zip
            having count(*) > 10)A1)A2) V1
 where ss_store_sk = s_store_sk
  and ss_sold_date_sk = d_date_sk
  and d_qoy = 2 and d_year = 2000
  and (substr(s_zip,1,2) = substr(V1.ca_zip,1,2))
 group by s_store_name
 order by s_store_name
 limit 100;

;
